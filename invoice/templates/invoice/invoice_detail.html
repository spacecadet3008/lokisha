{% extends "invoice/base_invoice.html" %}
{% load static %}
{% load humanize %}
{% block title %}Proforma Invoice #P{{ proforma.invoice_number|slice:"1:" }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="invoice-header">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h2><i class="fas fa-file-invoice-dollar me-2"></i>Proforma Invoice #P{{ proforma.invoice_number|slice:"1:" }}</h2>
                <p class="mb-0">Date: {{ proforma.date|date:"M d, Y" }} | Status: 
                    <span class="badge 
                        {% if proforma.status == 'draft' %}bg-secondary
                        {% elif proforma.status == 'sent' %}bg-info
                        {% elif proforma.status == 'accepted' %}bg-success
                        {% else %}bg-danger{% endif %}">
                        {{ proforma.status|title }}
                    </span>
                </p>
            </div>
            <div class="col-md-6 text-end">
                <img src="{% static 'images/logo/logo.png' %}" alt="Business Logo" height="60">
            </div>
        </div>
    </div>

    <!-- Actions -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="d-flex justify-content-between">
                <div>
                    <a href="{% url 'proforma_list' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1"></i> Back to List
                    </a>
                </div>
                <div>
                    {% if proforma.status in 'draft sent' and not proforma.converted_to_invoice %}
                    <a href="{% url 'proforma_convert' proforma.pk %}" class="btn btn-success me-2">
                        <i class="fas fa-exchange-alt me-1"></i> Convert to Invoice
                    </a>
                    {% endif %}

                    {% if proforma.pk %}
                    <a href="{% url 'proforma_edit' proforma.pk %}" class="btn btn-primary">Edit</a>
                    {% else %}
                    <button class="btn btn-primary" disabled>Edit</button>
                    {% endif %}
                    
                    <a href="?format=pdf" class="btn btn-danger me-2" target="_blank">
                        <i class="fas fa-file-pdf me-1"></i> PDF
                    </a>
                    <a href="?print=true" class="btn btn-info" target="_blank">
                        <i class="fas fa-print me-1"></i> Print
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Invoice Details -->
    <div class="row">
        <!-- Company Information -->
        <div class="col-md-6">
            <div class="card invoice-card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">From</h5>
                </div>
                <div class="card-body">
                    <h6 class="text-success">{{ company_name }}</h6>
                    <p class="mb-1">{{ company_address }}</p>
                    <p class="mb-1">Phone: {{ company_phone }}</p>
                    <p class="mb-0">Email: {{ company_email }}</p>
                </div>
            </div>
        </div>

        <!-- Customer Information -->
        <div class="col-md-6">
            <div class="card invoice-card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Bill To</h5>
                </div>
                <div class="card-body">
                    <h6>{{ proforma.customer_name.first_name }} {{ proforma.customer_name.last_name }}</h6>
                    <p class="mb-1">Phone: {{ proforma.contact_number }}</p>
                    {% if proforma.customer_name.email %}
                    <p class="mb-1">Email: {{ proforma.customer_name.email }}</p>
                    {% endif %}
                    {% if proforma.customer_name.address %}
                    <p class="mb-0">Address: {{ proforma.customer_name.address }}</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Items Table -->
    <div class="card invoice-card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Items</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered table-items">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th class="text-end">Quantity</th>
                            <th class="text-end">Unit Price (Tsh)</th>
                            <th style="width: 300px;" class="text-end">Total (Tsh)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in proforma.items.all %}
                        <tr>
                            <td style="width: 300px;">{{ item.item.name }}</td>
                            <td class="text-end">{{ item.quantity|intcomma:2 }}</td>
                            <td class="text-end">{{ item.price_per_item|intcomma:2 }}</td>
                            <td class="text-end">{{ item.total_price|intcomma:2 }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Totals -->
    <div class="row">
        <div class="col-md-6 offset-md-6">
            <div class="card invoice-card">
                <div class="card-body">
                    <div class="total-section">
                        <div class="row mb-2">
                            <div class="col-6">
                                <strong>Subtotal:</strong>
                            </div>
                            <div class="col-6 text-end">
                                Tsh {{ proforma.total|intcomma:2 }}
                            </div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-6">
                                <strong>Shipping:</strong>
                            </div>
                            <div class="col-6 text-end">
                                Tsh {{ proforma.shipping|intcomma:2 }}
                            </div>
                        </div>
                        <div class="row mt-3 pt-2 border-top">
                            <div class="col-6">
                                <strong class="h5">Grand Total:</strong>
                            </div>
                            <div class="col-6 text-end">
                                <span class="h4 text-success">Tsh {{ proforma.grand_total|intcomma:2 }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notes -->
    {% if proforma.status == 'draft' %}
    <div class="alert alert-info mt-4">
        <i class="fas fa-info-circle me-2"></i>
        This is a draft proforma invoice. It will not be visible to customers until sent.
    </div>
    {% endif %}

    {% if proforma.converted_to_invoice %}
    <div class="alert alert-success mt-4">
        <i class="fas fa-check-circle me-2"></i>
        This proforma has been converted to Invoice #{{ proforma.converted_to_invoice.invoice_number }}.
        <a href="{% url 'invoice_detail' proforma.converted_to_invoice.pk %}" class="alert-link">View Invoice</a>
    </div>
    {% endif %}
</div>
{% endblock %}
<!-- templates/invoice/delivery_form.html -->
{% extends "store/base.html" %}
{% load static %}
{% load sum_tags %}
{% block stylesheets %}
<style>
    .delivery-create-container {
        background: url('{% static "images/lokisha.png" %}') no-repeat center center fixed;
        background-size: cover;
        min-height: 100vh;
        padding: 20px;
    }
    .delivery-form-card {
        background: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(10px);
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    .form-minimal {
        padding: 25px;
    }
    .autocomplete-results {
        position: absolute;
        background: white;
        border: 1px solid #ddd;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        width: 100%;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .autocomplete-item {
        padding: 10px 15px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
    }
    .autocomplete-item:hover {
        background-color: #f8f9fa;
    }
    .btn-minimal {
        border-radius: 6px;
        padding: 10px 25px;
        font-weight: 500;
    }
    .item-row {
        margin-bottom: 15px;
        padding: 15px;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        background: #fafafa;
    }
    .selected-info {
        background-color: #e8f5e8;
        border-radius: 5px;
        padding: 10px;
        margin-top: 5px;
        font-size: 0.9em;
    }
</style>
{% endblock %}

{% block content %}
<div class="delivery-create-container">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="delivery-form-card">
                    <!-- Header -->
                    <div class="text-center p-4 border-bottom">
                        <h4 class="mb-1 text-primary">
                            <i class="fas fa-truck me-2"></i>
                            {% if form.instance.pk %}Edit{% else %}Create{% endif %} Delivery Note
                        </h4>
                        <p class="text-muted mb-0">{% if form.instance.pk %}Update{% else %}Fill in{% endif %} the delivery details</p>
                    </div>

                    <form method="post" id="delivery-form" class="form-minimal">
                        {% csrf_token %}
                        
                        <!-- Customer Section -->
                        <div class="mb-4">
                            <label class="form-label fw-bold text-dark">Customer Information *</label>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="position-relative">
                                        <input type="text" class="form-control customer-search" 
                                               placeholder="ðŸ” Type customer name or phone..." 
                                               data-url="{% url 'autocomplete_customers' %}"
                                               value="{% if form.customer_search.value %}{{ form.customer_search.value }}{% elif form.instance.customer_name %}{{ form.instance.customer_name.first_name }} {{ form.instance.customer_name.last_name }}{% endif %}"
                                               required>
                                        <div class="autocomplete-results" id="customer-results" style="display: none;"></div>
                                        {{ form.customer_name }}
                                    </div>
                                    <div class="text-danger" id="customer-error"></div>
                                </div>
                                <div class="col-md-6">
                                    {{ form.contact_number }}
                                    {% if form.contact_number.errors %}
                                    <div class="text-danger">{{ form.contact_number.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Selected Customer Info -->
                            <div class="selected-customer-info mt-3 p-3 bg-light rounded" 
                                 style="display: {% if form.instance.customer_name %}block{% else %}none{% endif %};">
                                <h6 class="mb-2">Selected Customer:</h6>
                                <div id="customer-details">
                                    {% if form.instance.customer_name %}
                                    <p class="mb-1"><strong>Name:</strong> {{ form.instance.customer_name.first_name }} {{ form.instance.customer_name.last_name }}</p>
                                    <p class="mb-1"><strong>Phone:</strong> {{ form.instance.contact_number }}</p>
                                    <p class="mb-0"><strong>Email:</strong> {{ form.instance.customer_name.email|default:"N/A" }}</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Delivery Address -->
                        <div class="mb-4">
                            <label class="form-label fw-bold text-dark">Delivery Address *</label>
                            {{ form.shipping_address }}
                            {% if form.shipping_address.errors %}
                            <div class="text-danger">{{ form.shipping_address.errors }}</div>
                            {% endif %}
                        </div>

                        <!-- Items Section -->
                        <div class="mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <label class="form-label fw-bold text-dark">Items *</label>
                                <button type="button" class="btn btn-sm btn-success" id="add-item">
                                    <i class="fas fa-plus me-1"></i> Add Item
                                </button>
                            </div>
                            
                            {{ formset.management_form }}
                            <div id="items-container">
                                {% for form in formset %}
                                <div class="item-row row g-3 align-items-end" data-form-index="{{ forloop.counter0 }}">
                                    {% for hidden in form.hidden_fields %}
                                        {{ hidden }}
                                    {% endfor %}
                                    
                                    <div class="col-md-5">
                                        <label class="form-label small text-muted">Item *</label>
                                        <div class="position-relative">
                                            <input type="text" class="form-control item-search" 
                                                   placeholder="ðŸ” Search item..." 
                                                   data-url="{% url 'autocomplete_items' %}"
                                                   value="{% if form.instance.item %}{{ form.instance.item.name }}{% endif %}"
                                                   required>
                                            <div class="autocomplete-results" style="display: none;"></div>
                                            {{ form.item }}
                                        </div>
                                        <!-- Selected Item Info -->
                                        <div class="selected-item-info mt-2" 
                                             style="display: {% if form.instance.item %}block{% else %}none{% endif %};">
                                            <small>
                                                {% if form.instance.item %}
                                                <span class="item-name fw-bold text-success">{{ form.instance.item.name }}</span>
                                                <span class="item-stock text-muted"> ({{ form.instance.item.quantity }} available)</span>
                                                <span class="item-price text-dark"> - Tsh {{ form.instance.price_per_item|default:form.instance.item.price|floatformat:2 }}</span>
                                                {% endif %}
                                            </small>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-2">
                                        <label class="form-label small text-muted">Quantity *</label>
                                        {{ form.quantity }}
                                    </div>
                                    
                                    <div class="col-md-2">
                                        <label class="form-label small text-muted">Price *</label>
                                        {{ form.price_per_item }}
                                    </div>
                                    
                                    <div class="col-md-2">
                                        <label class="form-label small text-muted">Total</label>
                                        <input type="text" class="form-control total-input" readonly 
                                               value="Tsh {% if form.instance.quantity and form.instance.price_per_item %}{{ form.instance.total_price|floatformat:2 }}{% else %}0.00{% endif %}">
                                    </div>
                                    
                                    <div class="col-md-1">
                                        <label class="form-label small text-muted">&nbsp;</label>
                                        <button type="button" class="btn btn-sm btn-danger remove-item w-100">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            <div class="text-danger" id="items-error"></div>
                        </div>

                        <!-- Delivery Total -->
                        <div class="row mb-4">
                            <div class="col-md-6 offset-md-6">
                                <div class="border-top pt-3">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span class="fw-bold">Total Value:</span>
                                        <span id="delivery-total" class="fw-bold">
                                            Tsh {% if form.instance.pk %}{{ form.instance.items.all|sum_attr:'total_price'|default:0|floatformat:2 }}{% else %}0.00{% endif %}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Delivery Notes and Status -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label class="form-label fw-bold text-dark">Delivery Notes</label>
                                {{ form.notes }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold text-dark">Status</label>
                                {{ form.status }}
                            </div>
                        </div>

                        <!-- Actions -->
                        <div class="text-end pt-3 border-top">
                            <a href="{% url 'delivery_list' %}" class="btn btn-secondary btn-minimal me-2">
                                <i class="fas fa-times me-1"></i> Cancel
                            </a>
                            <button type="submit" class="btn btn-primary btn-minimal">
                                <i class="fas fa-save me-1"></i> {% if form.instance.pk %}Update{% else %}Create{% endif %} Delivery
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
<script>
$(document).ready(function() {
    // Initialize with existing data
    function initializeExistingData() {
        {% if form.instance.pk %}
        // Show customer info if it exists
        const customerId = $('#id_customer_name').val();
        if (customerId) {
            $('.selected-customer-info').show();
        }
        
        // Calculate initial totals
        calculateTotals();
        {% endif %}
    }

    // Customer search functionality
    function setupCustomerSearch() {
        const customerSearch = $('.customer-search');
        const customerResults = $('#customer-results');
        const customerIdField = $('#id_customer_name');
        const contactField = $('#id_contact_number');
        const customerInfo = $('.selected-customer-info');
        
        customerSearch.on('input', function() {
            const query = $(this).val();
            if (query.length < 2) {
                customerResults.hide();
                return;
            }
            
            customerSearch.addClass('autocomplete-loading');
            
            $.get('{% url "autocomplete_customers" %}', {q: query}, function(data) {
                customerSearch.removeClass('autocomplete-loading');
                
                if (data.results && data.results.length > 0) {
                    customerResults.empty();
                    data.results.forEach(function(customer) {
                        customerResults.append(
                            `<div class="autocomplete-item" data-customer-id="${customer.id}" 
                                  data-first-name="${customer.first_name}" 
                                  data-last-name="${customer.last_name}"
                                  data-phone="${customer.phone}"
                                  data-email="${customer.email || 'N/A'}">
                                ${customer.first_name} ${customer.last_name} (${customer.phone})
                            </div>`
                        );
                    });
                    customerResults.show();
                } else {
                    customerResults.hide();
                }
            });
        });
        
        // Handle customer selection
        $(document).on('click', '.autocomplete-item', function() {
            const customerId = $(this).data('customer-id');
            const firstName = $(this).data('first-name');
            const lastName = $(this).data('last-name');
            const phone = $(this).data('phone');
            const email = $(this).data('email');
            
            // Set the hidden field value
            customerIdField.val(customerId);
            
            // Set contact number
            contactField.val(phone);
            
            // Update customer info display
            $('#customer-details').html(`
                <p class="mb-1"><strong>Name:</strong> ${firstName} ${lastName}</p>
                <p class="mb-1"><strong>Phone:</strong> ${phone}</p>
                <p class="mb-0"><strong>Email:</strong> ${email}</p>
            `);
            customerInfo.show();
            
            // Update search field with customer name
            customerSearch.val(firstName + ' ' + lastName);
            
            // Hide results
            customerResults.hide();
            $('#customer-error').text('');
        });
    }

    // Item search functionality
    function setupItemSearch() {
        $(document).on('input', '.item-search', function() {
            const row = $(this).closest('.item-row');
            const results = row.find('.autocomplete-results');
            const query = $(this).val();
            
            if (query.length < 2) {
                results.hide();
                return;
            }
            
            $(this).addClass('autocomplete-loading');
            
            $.get('{% url "autocomplete_items" %}', {q: query}, function(data) {
                $(this).removeClass('autocomplete-loading');
                
                if (data.results && data.results.length > 0) {
                    results.empty();
                    data.results.forEach(function(item) {
                        results.append(
                            `<div class="autocomplete-item" data-item-id="${item.id}" 
                                  data-name="${item.name}"
                                  data-price="${item.price_per_item}"
                                  data-quantity="${item.quantity}">
                                ${item.name} (${item.quantity} available) - Tsh ${item.price_per_item}
                            </div>`
                        );
                    });
                    results.show();
                } else {
                    results.hide();
                }
            }.bind(this));
        });
        
        // Handle item selection
        $(document).on('click', '.autocomplete-item', function() {
            const row = $(this).closest('.item-row');
            const itemId = $(this).data('item-id');
            const itemName = $(this).data('name');
            const itemPrice = $(this).data('price');
            const itemQuantity = $(this).data('quantity');
            
            // Set the hidden field value
            row.find('[name$="-item"]').val(itemId);
            
            // Set price automatically
            const priceField = row.find('[name$="-price_per_item"]');
            priceField.val(itemPrice);
            
            // Update item info display
            const infoDiv = row.find('.selected-item-info');
            infoDiv.html(`
                <small>
                    <span class="item-name fw-bold text-success">${itemName}</span>
                    <span class="item-stock text-muted"> (${itemQuantity} available)</span>
                    <span class="item-price text-dark"> - Tsh ${parseFloat(itemPrice).toFixed(2)}</span>
                </small>
            `);
            infoDiv.show();
            
            // Update search field with item name
            row.find('.item-search').val(itemName);
            
            // Hide results
            row.find('.autocomplete-results').hide();
            
            // Calculate totals
            calculateTotals();
        });
    }

    // Auto-calculation functions
    function calculateRowTotal(row) {
        const quantity = parseFloat(row.find('[name$="-quantity"]').val()) || 0;
        const price = parseFloat(row.find('[name$="-price_per_item"]').val()) || 0;
        const total = quantity * price;
        row.find('.total-input').val('Tsh ' + total.toFixed(2));
        return total;
    }

    function calculateTotals() {
        let deliveryTotal = 0;
        $('.item-row').each(function() {
            deliveryTotal += calculateRowTotal($(this));
        });
        
        $('#delivery-total').text('Tsh ' + deliveryTotal.toFixed(2));
    }

    // Add new item row
    $('#add-item').click(function() {
        const totalForms = $('#id_items-TOTAL_FORMS');
        const formCount = parseInt(totalForms.val());
        const lastRow = $('.item-row').last();
        const newRow = lastRow.clone();
        
        // Clear all values in the new row
        newRow.find('input').val('');
        newRow.find('.item-search').val('');
        newRow.find('.selected-item-info').hide();
        newRow.find('.total-input').val('Tsh 0.00');
        
        // Update all field names with the new index
        newRow.find('[name]').each(function() {
            const name = $(this).attr('name');
            if (name) {
                const newName = name.replace(/-\d+-/, '-' + formCount + '-');
                $(this).attr('name', newName);
                
                const id = $(this).attr('id');
                if (id) {
                    const newId = id.replace(/-\d+-/, '-' + formCount + '-');
                    $(this).attr('id', newId);
                }
            }
        });
        
        // Append the new row
        $('#items-container').append(newRow);
        
        // Update the total forms count
        totalForms.val(formCount + 1);
    });

    // Remove item row
    $(document).on('click', '.remove-item', function() {
        const $row = $(this).closest('.item-row');
        if ($('.item-row').length > 1) {
            $row.remove();
            $('#id_items-TOTAL_FORMS').val($('.item-row').length);
            calculateTotals();
        }
    });

    // Event listeners
    $(document).on('input', '[name$="-quantity"], [name$="-price_per_item"]', calculateTotals);
    
    // Hide autocomplete when clicking outside
    $(document).on('click', function(e) {
        if (!$(e.target).closest('.customer-search, .autocomplete-results').length) {
            $('#customer-results').hide();
        }
        $('.autocomplete-results').each(function() {
            if (!$(e.target).closest('.item-search, .autocomplete-results').length) {
                $(this).hide();
            }
        });
    });

    // Initialize
    setupCustomerSearch();
    setupItemSearch();
    initializeExistingData();
    
    // Set focus to customer search
    setTimeout(function() {
        $('.customer-search').focus();
    }, 100);
});
</script>
{% endblock %}